## Thread (스레드)

### 프로세스와 스레드

---
- 요청을 실행하는 실행의 단위
- 프로세스
  - 하나의 프로그램 = 프로세스 (작업의 단위)
  - 프로세스는 운영체제로부터 시스템 자원을 할당받아 실행된다.
  - 여러 프로세스는 각각의 자원을 가지고 실행되기에 용량이 많이 필요하다.
- 동시성
    - 동시에 실행되는 것처럼 보이지만, 실제로는 빠르게 여러 작업이 전환되면서 실행되는 것 (실제로는 한 순간에는 하나만 실행)
- 병렬성
    - 실제로 여러 작업이 동시에 실행되는 것
- CPU 코어
    - 싱글 코어
      - 하나의 CPU 코어는 실제로는 한 순간에 하나의 프로세스만 실행할 수 있지만,   
        이를 빠르게 전환하여 동시에 실행되는 것처럼 보인다. (동시성)
    - 멀티 코어
      - CPU 코어가 여러개인 컴퓨터의 경우,   
        각 코어별로 하나의 프로세스를 실행하기 때문에 여러 프로세스가 실제로 동시에 실행된다. (병렬성)

### 컨텍스트 스위칭 (Context Switching)

---
- 운영체제가 다중 작업을 지원하기 위해 프로세스/스레드 간의 실행 상태를 전환하는 과정
- 하나의 프로세스 내에서 여러개의 스레드가 동작할 때, 이들은 운영체제의 스케쥴러에 의해 동작한다.
- 현재 실행중인 작업의 상태를 저장하고, 다음 실행할 작업의 상태를 불러온다.
- 하나의 CPU는 동시에 하나의 프로세스만을 처리할 수 있기 때문에   
  CPU를 작은 시간단위로 나누어 전환하면서 프로세스를 실행, 동시에 실행되는 것처럼 보인다.
- 발생
    - 시분할 시스템
      - 여러 프로세스/스레드가 CPU를 공유하는 환경에서는 각 작업에 일정한 시간을 할당하여 실행하기 때문에, 각 작업들을 전환하는 작업이 필요하다.
    - 인터럽트
      - 하드웨어/소프트웨어에서 발생하는 여러 인터럽트에 의해 현재 실행중인 작업이 중단되면, 인터럽스 루틴 후에 원래 실행으로 돌아가기 위한 작업이 필요하다.
- 순서
    - 현재 실행중인 작업의 상태를 저장 (레지스터 상태, 프로그램카운터, 스택 포인터 등의 정보)
    - 다음 실행할 작업의 상태 불러오기 (메모리에서 불러오기)
    - 다음에 실행할 작업의 상태로 CPU를 전환하고, 실행
- 멀티 프로세스
    - 장점
        - 독립적으로 실행되니, 각각의 프로세스간의 자원의 동기화가 필요하지 않다.
    - 단점
        - 독립적인 메모리 영역을 가진 프로세스들을 전환하면서 실행해야 하니 전환시에 비용이 많이 든다.(성능저하, 오버헤드 발생 가능성)
- 멀티 스레드
  - 장점
      - 자원을 공유하기 때문에 비용이 적게 든다.
  - 단점
      - 자원을 공유하기 때문에, 동기화 처리가 중요하다.
          - 하나의 스레드가 공유 데이터를 변경하는 시점에, 다른 스레드가 그 값을 읽으면 동기화 문제 발생
              - 1\. A 스레드가 변수의 값을 확인
              - 2\. B 스레드로 전환
              - 3\. B 스레드에서 변수의 값을 변경
              - 4\. A 스레드로 돌아옴
              - 5\. 이전에 확인한 변수의 값이 변경되어 있지만, 모른채로 실행됨
  - 동기화의 문제 - 데드락
      - 둘 이상의 스레드가 서로 상대방의 작업이 끝나기를 기다리며 무한하게 대기하는 상태
      - 작업이 진행되지 않고, 프로그램이 응답하지 않게 되면 프로그램의 실행이 중단될 수 있다.
      - 해결방법
          - 자원의 타임아웃 - 일정 시간이 지나면 반납되게 설정
          - 데드락을 감지하고 복구하는 매커니즘을 구현, 주기적으로 시스템의 상태를 점검하여 데드락을 확인